generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum FlyCategory {
  dry
  nymph
  streamer
  emerger
  saltwater
  other
}

enum Difficulty {
  beginner
  intermediate
  advanced
}

enum WaterType {
  freshwater
  saltwater
  both
}

enum MaterialType {
  hook
  thread
  tail
  body
  rib
  thorax
  wing
  hackle
  bead
  weight
  other
}

enum SubstitutionType {
  equivalent
  budget
  aesthetic
  availability
}

enum ResourceType {
  video
  blog
  pdf
}

enum CommissionType {
  percentage
  flat
}

enum SourceType {
  youtube
  blog
  pdf
}

enum StagedStatus {
  discovered
  scraped
  extracted
  normalized
  approved
  rejected
  ingested
}

enum UserRole {
  user
  admin
}

enum SubmissionStatus {
  pending
  approved
  rejected
}

// ─── News Models ────────────────────────────────────────────────────────────

model NewsArticle {
  id          String   @id @default(uuid()) @db.Uuid
  url         String   @unique
  title       String
  summary     String   @db.Text
  sourceName  String   @map("source_name")
  sourceUrl   String   @map("source_url")
  author      String?
  imageUrl    String?  @map("image_url")
  publishedAt DateTime @map("published_at")
  scrapedAt   DateTime @default(now()) @map("scraped_at")

  @@index([publishedAt])
  @@index([scrapedAt])
  @@map("news_articles")
}

// ─── User & Auth Models ─────────────────────────────────────────────────────

model User {
  id           String   @id @default(uuid()) @db.Uuid
  username     String   @unique
  email        String   @unique
  passwordHash String   @map("password_hash")
  displayName  String?  @map("display_name")
  bio          String?  @db.Text
  avatarUrl    String?  @map("avatar_url")
  role         UserRole @default(user)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  sessions           Session[]
  comments           Comment[]
  likes              Like[]
  savedPatterns      SavedPattern[]
  forumPosts         ForumPost[]
  forumReplies       ForumReply[]
  sentMessages       DirectMessage[]        @relation("SentMessages")
  receivedMessages   DirectMessage[]        @relation("ReceivedMessages")
  submittedPatterns  UserSubmittedPattern[]

  @@map("users")
}

model Session {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// ─── Community Models ───────────────────────────────────────────────────────

model Comment {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  flyPatternId String   @map("fly_pattern_id") @db.Uuid
  content      String   @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  flyPattern FlyPattern @relation(fields: [flyPatternId], references: [id], onDelete: Cascade)

  @@index([flyPatternId])
  @@index([userId])
  @@map("comments")
}

model Like {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  flyPatternId String   @map("fly_pattern_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  flyPattern FlyPattern @relation(fields: [flyPatternId], references: [id], onDelete: Cascade)

  @@unique([userId, flyPatternId])
  @@index([flyPatternId])
  @@index([userId])
  @@map("likes")
}

model SavedPattern {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  flyPatternId String   @map("fly_pattern_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  flyPattern FlyPattern @relation(fields: [flyPatternId], references: [id], onDelete: Cascade)

  @@unique([userId, flyPatternId])
  @@index([flyPatternId])
  @@index([userId])
  @@map("saved_patterns")
}

model ForumPost {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  content   String   @db.Text
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  replies ForumReply[]

  @@index([userId])
  @@index([createdAt])
  @@map("forum_posts")
}

model ForumReply {
  id        String   @id @default(uuid()) @db.Uuid
  postId    String   @map("post_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@map("forum_replies")
}

model DirectMessage {
  id         String   @id @default(uuid()) @db.Uuid
  senderId   String   @map("sender_id") @db.Uuid
  receiverId String   @map("receiver_id") @db.Uuid
  content    String   @db.Text
  read       Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("direct_messages")
}

model UserSubmittedPattern {
  id          String           @id @default(uuid()) @db.Uuid
  userId      String           @map("user_id") @db.Uuid
  name        String
  category    FlyCategory
  difficulty  Difficulty
  waterType   WaterType        @map("water_type")
  description String           @db.Text
  materials   Json             @db.JsonB
  status      SubmissionStatus @default(pending)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("user_submitted_patterns")
}

// ─── Pipeline Staging Models ────────────────────────────────────────────────

model StagedSource {
  id           String       @id @default(uuid()) @db.Uuid
  sourceType   SourceType   @map("source_type")
  url          String       @unique
  title        String?
  creatorName  String?      @map("creator_name")
  platform     String?
  rawContent   String?      @map("raw_content") @db.Text
  patternQuery String       @map("pattern_query")
  status       StagedStatus @default(discovered)
  metadata     Json?        @db.JsonB
  scrapedAt    DateTime?    @map("scraped_at")
  createdAt    DateTime     @default(now()) @map("created_at")

  extractions StagedExtraction[]

  @@index([status])
  @@index([patternQuery])
  @@map("staged_sources")
}

model StagedExtraction {
  id              String       @id @default(uuid()) @db.Uuid
  sourceId        String       @map("source_id") @db.Uuid
  patternName     String       @map("pattern_name")
  normalizedSlug  String       @map("normalized_slug")
  extractedData   Json         @map("extracted_data") @db.JsonB
  confidence      Float
  status          StagedStatus @default(extracted)
  reviewNotes     String?      @map("review_notes") @db.Text
  createdAt       DateTime     @default(now()) @map("created_at")
  reviewedAt      DateTime?    @map("reviewed_at")

  source StagedSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([normalizedSlug])
  @@index([status])
  @@index([confidence])
  @@map("staged_extractions")
}

model CanonicalMaterial {
  id            String       @id @default(uuid()) @db.Uuid
  canonicalName String       @unique @map("canonical_name")
  materialType  MaterialType @map("material_type")
  aliases       String[]
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  @@index([materialType])
  @@map("canonical_materials")
}

// ─── Production Models ──────────────────────────────────────────────────────

model FlyPattern {
  id          String      @id @default(uuid()) @db.Uuid
  name        String      @unique
  slug        String      @unique
  category    FlyCategory
  difficulty  Difficulty
  waterType   WaterType   @map("water_type")
  description String      @db.Text
  origin      String?     @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  materials     FlyPatternMaterial[]
  variations    Variation[]
  resources     Resource[]
  feedback      Feedback[]
  comments      Comment[]
  likes         Like[]
  savedPatterns SavedPattern[]

  @@index([slug])
  @@index([category])
  @@index([difficulty])
  @@index([waterType])
  @@map("fly_patterns")
}

model Material {
  id          String       @id @default(uuid()) @db.Uuid
  name        String
  type        MaterialType
  description String?      @db.Text
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  flyPatternMaterials FlyPatternMaterial[]
  substitutionsFrom   MaterialSubstitution[] @relation("SubstitutionFrom")
  substitutionsTo     MaterialSubstitution[] @relation("SubstitutionTo")
  affiliateLinks      AffiliateLink[]
  variationOriginals  VariationOverride[]    @relation("VariationOriginal")
  variationReplacements VariationOverride[]  @relation("VariationReplacement")

  @@unique([name, type])
  @@map("materials")
}

model FlyPatternMaterial {
  id           String     @id @default(uuid()) @db.Uuid
  flyPatternId String     @map("fly_pattern_id") @db.Uuid
  materialId   String     @map("material_id") @db.Uuid
  customColor  String?    @map("custom_color")
  customSize   String?    @map("custom_size")
  required     Boolean    @default(true)
  position     Int

  flyPattern   FlyPattern @relation(fields: [flyPatternId], references: [id], onDelete: Cascade)
  material     Material   @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([flyPatternId])
  @@index([materialId])
  @@map("fly_pattern_materials")
}

model MaterialSubstitution {
  id                   String           @id @default(uuid()) @db.Uuid
  materialId           String           @map("material_id") @db.Uuid
  substituteMaterialId String           @map("substitute_material_id") @db.Uuid
  substitutionType     SubstitutionType @map("substitution_type")
  notes                String           @db.Text

  material             Material         @relation("SubstitutionFrom", fields: [materialId], references: [id], onDelete: Cascade)
  substituteMaterial   Material         @relation("SubstitutionTo", fields: [substituteMaterialId], references: [id], onDelete: Cascade)

  @@map("material_substitutions")
}

model Variation {
  id           String     @id @default(uuid()) @db.Uuid
  flyPatternId String     @map("fly_pattern_id") @db.Uuid
  name         String
  description  String     @db.Text

  flyPattern   FlyPattern @relation(fields: [flyPatternId], references: [id], onDelete: Cascade)
  overrides    VariationOverride[]

  @@index([flyPatternId])
  @@map("variations")
}

model VariationOverride {
  id                    String    @id @default(uuid()) @db.Uuid
  variationId           String    @map("variation_id") @db.Uuid
  originalMaterialId    String    @map("original_material_id") @db.Uuid
  replacementMaterialId String    @map("replacement_material_id") @db.Uuid

  variation             Variation @relation(fields: [variationId], references: [id], onDelete: Cascade)
  originalMaterial      Material  @relation("VariationOriginal", fields: [originalMaterialId], references: [id], onDelete: Cascade)
  replacementMaterial   Material  @relation("VariationReplacement", fields: [replacementMaterialId], references: [id], onDelete: Cascade)

  @@map("variation_overrides")
}

model Resource {
  id           String       @id @default(uuid()) @db.Uuid
  flyPatternId String       @map("fly_pattern_id") @db.Uuid
  type         ResourceType
  title        String
  creatorName  String       @map("creator_name")
  platform     String
  url          String
  qualityScore Int          @map("quality_score") @db.SmallInt

  flyPattern   FlyPattern   @relation(fields: [flyPatternId], references: [id], onDelete: Cascade)

  @@index([flyPatternId])
  @@map("resources")
}

model AffiliateLink {
  id             String         @id @default(uuid()) @db.Uuid
  materialId     String         @map("material_id") @db.Uuid
  retailer       String
  url            String
  commissionType CommissionType @map("commission_type")

  material       Material       @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@map("affiliate_links")
}

model Feedback {
  id           String     @id @default(uuid()) @db.Uuid
  flyPatternId String     @map("fly_pattern_id") @db.Uuid
  helpful      Boolean
  comment      String     @db.Text
  createdAt    DateTime   @default(now()) @map("created_at")

  flyPattern   FlyPattern @relation(fields: [flyPatternId], references: [id], onDelete: Cascade)

  @@index([flyPatternId])
  @@map("feedback")
}
